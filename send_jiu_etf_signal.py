#!/usr/bin/env python
# -*- coding: utf-8 -*-

import sys
import os
sys.path.append(os.path.dirname(os.path.abspath(__file__)))
from datetime import datetime
import yaml
import requests
import json

# ç›´æ¥ä»é…ç½®æ–‡ä»¶è¯»å–access_token
config_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'config', 'system.yaml')
with open(config_path, 'r', encoding='utf-8') as f:
    config = yaml.safe_load(f)

dingding_config = config.get('system', {}).get('dingding', {})
access_token = dingding_config.get('access_token', '')
webhook_url = f"https://oapi.dingtalk.com/robot/send?access_token={access_token}"

# æ„å»ºåŒ…å«æ‰€æœ‰è¿‘æœŸä¿¡å·çš„é…’ETFäº¤æ˜“ä¿¡å·è¯¦æƒ…
message = (
    "ã€é…’ETF (512690) äº¤æ˜“ä¿¡å·æ±‡æ€»æŠ¥å‘Š - ç¼ è®ºéªŒè¯ç‰ˆã€‘\n\n"
    f"ğŸ“… åˆ†ææ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n"
    "ğŸ“Š æœ€æ–°è¡Œæƒ…: 0.582å…ƒ\n\n"
    "ğŸ”¥ æœ€æ–°ç¡®è®¤ä¿¡å· (ä¼˜å…ˆçº§æœ€é«˜):\n"
    "  â€¢ æ—¥æœŸ: 2025-11-17\n"
    "  â€¢ ä¿¡å·ç±»å‹: ä¸‰ä¹°ä¿¡å· (ç¬¦åˆç¼ è®ºé€»è¾‘ï¼Œé«˜æ¦‚ç‡æœ‰æ•ˆ)\n"
    "  â€¢ ä¿¡å·å¼ºåº¦: 64%\n"
    "  â€¢ ä¿¡å·ä»·æ ¼: 0.591å…ƒ\n"
    "  â€¢ æ¡ä»¶: çªç ´æ—¥çº¿ä¸­æ¢ + å›æŠ½ä¸è¿›ä¸­æ¢ï¼Œè·ç¦»æœ‰æ•ˆä¸€ä¹°çº¦20å¤©\n\n"
    "âœ… æœ‰æ•ˆä¸€ä¹°ä¿¡å·è®°å½• (ç¬¦åˆç¼ è®ºé€»è¾‘):\n"
    "  â€¢ 2025-10-27: ä¸€ä¹°ä¿¡å· (å¼ºåº¦60%) - ä»·æ ¼0.577å…ƒ - æ—¥çº¿åº•èƒŒé©° + åº•åˆ†å‹\n"
    "  â€¢ 2025-10-09: ä¸€ä¹°ä¿¡å· (å¼ºåº¦60%) - ä»·æ ¼0.577å…ƒ - å°çº§åˆ«ä¸€ä¹°ï¼Œç¬¦åˆèµ°åŠ¿è§„å¾‹\n\n"
    "âŒ å·²æ’é™¤è¯¯åˆ¤ä¿¡å· (çº§åˆ«æ··æ·†å¯¼è‡´):\n"
    "  â€¢ 11æœˆ5æ—¥ã€11æœˆ10æ—¥: å°çº§åˆ«æ³¢åŠ¨ä½ç‚¹ï¼Œæ—¥çº¿çº§åˆ«æœªå®ŒæˆèƒŒé©°ç»“æ„\n"
    "  â€¢ 10æœˆ13æ—¥: å¯èƒ½ä¸ºä¸­ç»§å›è°ƒä½ç‚¹ï¼Œé—´éš”è¿‡çŸ­ä¸ç¬¦åˆæ—¥çº¿ä¸€ä¹°ç‰¹å¾\n\n"
    "ğŸ¯ äº¤æ˜“å»ºè®®:\n"
    "  â€¢ ä¸»è¦å…³æ³¨: 11æœˆ17æ—¥ä¸‰ä¹°ä¿¡å· (æœ€ä¼˜å…¥åœºç‚¹)\n"
    "  â€¢ å…¥åœºä»·æ ¼: å½“å‰0.582å…ƒ (å¯åˆ†æ‰¹å»ºä»“)\n"
    "  â€¢ ç›®æ ‡ä»·ä½: 0.620å…ƒ\n"
    "  â€¢ æ­¢æŸä»·ä½: 0.560å…ƒ\n"
    "  â€¢ å»ºè®®ä»“ä½: 10%\n\n"
    "ğŸ“Š ä¿®æ­£åä¿¡å·ç»Ÿè®¡ (æ—¥çº¿çº§åˆ«):\n"
    "  â€¢ è¿‡å»3ä¸ªæœˆæœ‰æ•ˆæ—¥çº¿ä¿¡å·: 3-4ä¸ª\n"
    "  â€¢ å…¶ä¸­ä¸‰ä¹°ä¿¡å·: 1ä¸ª (11æœˆ17æ—¥)\n"
    "  â€¢ å…¶ä¸­ä¸€ä¹°ä¿¡å·: 2-3ä¸ª (åŒ…å«10æœˆ9æ—¥ã€10æœˆ27æ—¥)\n"
    "  â€¢ å¹³å‡ä¿¡å·å¼ºåº¦: 62% (ç¬¦åˆé…’ETFéœ‡è¡åå¼ºç‰¹å¾)\n\n"
    "ğŸ” æ ¸å¿ƒç¼ è®ºéªŒè¯ç»“æœ:\n"
    "  â€¢ ä¸‰ä¹°ä¿¡å·: ç¬¦åˆ'çªç ´æ—¥çº¿ä¸­æ¢+å›æŠ½ä¸è¿›ä¸­æ¢'å®šä¹‰\n"
    "  â€¢ æœ‰æ•ˆä¸€ä¹°: æ»¡è¶³'ä¸‹è·Œè¶‹åŠ¿èƒŒé©°+åº•åˆ†å‹'ä¸”æ—¶é—´é—´éš”åˆç†\n"
    "  â€¢ ä¿¡å·çº§åˆ«: å·²åŒºåˆ†æ—¥çº¿çº§åˆ«ä¸å°çº§åˆ«ä¿¡å·\n\n"
    "âš ï¸ é£é™©æç¤º:\n"
    "  â€¢ ä¸¥æ ¼æ‰§è¡Œæ­¢æŸç­–ç•¥ï¼Œæ§åˆ¶é£é™©æ•å£\n"
    "  â€¢ å¸‚åœºæ³¢åŠ¨è¾ƒå¤§ï¼Œå»ºè®®åˆ†æ‰¹å»ºä»“\n"
    "  â€¢ è¯·ç»“åˆå¤§ç›˜èµ°åŠ¿å’Œè¡Œä¸šåŸºæœ¬é¢åˆ†æ\n"
    "  â€¢ ä»…ä¾›å‚è€ƒï¼Œé£é™©è‡ªè´Ÿ\n\n"
    f"â° æŠ¥å‘Šç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
)

# ç›´æ¥å‘é€é’‰é’‰æ¶ˆæ¯
headers = {
    "Content-Type": "application/json",
    "User-Agent": "Mozilla/5.0"
}

post_data = {
    "msgtype": "text",
    "text": {
        "content": f"QT: {message}"
    }
}

try:
    response = requests.post(
        webhook_url,
        data=json.dumps(post_data),
        headers=headers,
        timeout=10
    )
    
    if response.status_code == 200:
        result = response.json()
        if result.get('errcode') == 0:
            print("é…’ETFäº¤æ˜“ä¿¡å·å·²æˆåŠŸå‘é€åˆ°é’‰é’‰")
        else:
            print(f"é…’ETFäº¤æ˜“ä¿¡å·å‘é€å¤±è´¥: {result.get('errmsg')}")
    else:
        print(f"HTTPé”™è¯¯: {response.status_code}")
except Exception as e:
    print(f"å‘é€å¼‚å¸¸: {str(e)}")