# 缠论量化交易框架最新版

本文档详细描述了当前缠论量化交易系统的整体架构、核心功能模块、数据流程以及使用方法，用于指导系统扩展和信号对比分析。

## 1. 系统架构概述

当前系统采用模块化设计，主要包含以下核心组件：

### 1.1 目录结构

```
/Users/pingan/tools/trade/tianyuan/
├── src/                # 核心源码目录
│   ├── __init__.py
│   ├── backtester.py   # 回测引擎
│   ├── calculator.py   # 缠论计算器（核心）
│   ├── config.py       # 配置管理
│   ├── data_fetcher.py # 数据获取器
│   ├── data_processor.py # 数据处理器
│   ├── divergence_detector.py # 背驰检测器
│   ├── exporter.py     # 数据导出器
│   ├── monitor.py      # 监控器
│   ├── main.py         # 主程序入口
│   └── ...
├── config/             # 配置文件目录
│   ├── etfs.yaml       # ETF配置（核心交易标的）
│   ├── system.yaml     # 系统配置
│   └── risk_rules.yaml # 风控规则
├── tests/              # 测试目录
│   ├── src_tests/      # 从src目录移动的非核心测试文件
│   └── ...
├── data/               # 数据目录
│   ├── daily/          # 日线数据
│   ├── weekly/         # 周线数据
│   └── minute/         # 分钟线数据
├── outputs/            # 输出目录
│   ├── backtest/       # 回测结果
│   ├── exports/        # 导出数据
│   ├── plots/          # 图表
│   └── reports/        # 报告
└── docs/               # 文档目录
```

### 1.2 核心模块说明

#### 1.2.1 缠论计算模块 (calculator.py)
- **功能**：实现缠论算法核心，包括分型识别、笔划分、中枢识别、背驰检测
- **关键特性**：
  - 支持多级别的缠论分析
  - 集成MACD指标计算
  - 实现信号强度评分
  - 支持交易信号生成（一买、二买、三买等）

#### 1.2.2 数据获取与处理模块
- **data_fetcher.py**：负责从数据源获取原始市场数据
- **data_processor.py**：负责数据清洗、格式转换和预处理
- **divergence_detector.py**：专门用于检测价格与指标之间的背驰关系

#### 1.2.3 回测系统 (backtester.py)
- 支持历史数据回测
- 实现资金管理和仓位控制
- 计算绩效指标（收益率、最大回撤、夏普比率等）
- 支持策略参数优化

#### 1.2.4 监控系统 (monitor.py)
- 实时监控市场数据
- 基于缠论信号自动生成交易建议
- 支持钉钉通知
- 实现资金动态分配

#### 1.2.5 主程序 (main.py)
- 提供多种运行模式：
  - 单次扫描 (scan_once)
  - 监控模式 (monitor)
  - 日内模式 (intraday)
  - 盘前报告 (pre_market)
  - 盘后日报 (daily)
  - 周报告 (weekly_report)
  - 分钟线分析 (minute)

## 2. 交易标的配置（etfs.yaml）

当前系统支持多种类型的ETF交易标的，按类别组织：

### 2.1 标的类别
- **broad**: 宽基ETF（如沪深300、上证50、中证500等）
- **sector**: 行业ETF（如医药、军工、芯片、银行、证券等）
- **theme**: 主题ETF（如消费、酒、新能源车等）
- **hk**: 港股相关ETF
- **us**: 美股相关ETF
- **commodity**: 商品ETF（如黄金）
- **bond**: 债券ETF

### 2.2 关键配置项
每个标的包含以下配置：
- **enabled**: 是否启用该标的
- **name**: 标的名称
- **market**: 市场代码（sh/sz）
- **type**: 标的类型
- **commission**: 佣金比例
- **position_limit**: 最大仓位限制
- **stop_loss**: 止损比例
- **black_swan_enabled**: 是否启用黑天鹅模式
- **volume_requirement**: 成交量要求

## 3. 交易信号生成机制

### 3.1 信号类型
系统支持以下交易信号：
- **一买信号**：底部背驰后的第一个买入点
- **二买信号**：上涨趋势中回调形成的买入点
- **三买信号**：中枢上方的买入点
- **强烈买入/买入/谨慎买入**：基于信号强度的分类

### 3.2 信号检测流程
1. 数据获取与预处理
2. 缠论指标计算（分型、笔、中枢）
3. 背驰检测
4. 信号强度评分
5. 信号生成与验证

### 3.3 信号验证机制
signal_validator.py实现了信号验证功能，确保生成的信号：
- 满足价格条件
- 满足日线条件
- 未过期
- 价格形态稳定
- 背驰信号持续
- 趋势方向一致

## 4. 资金管理系统

### 4.1 资金分配策略
- 基于信号强度的动态仓位计算
- 单个标的最大仓位限制（通过position_limit配置）
- 总持仓比例控制（max_total_position）
- 根据不同ETF类型设置不同的风险参数

### 4.2 风险控制
- 止损机制（stop_loss配置）
- 最大回撤限制
- 黑天鹅模式（black_swan_enabled）
- 成交量过滤（volume_requirement）

## 5. 运行模式与使用方法

### 5.1 主要运行模式

#### 5.1.1 单次扫描模式
```bash
python src/main.py --symbol 512660 --mode scan_once --timeframe daily
```

#### 5.1.2 监控模式
```bash
python src/main.py --mode monitor --symbols 510300 512660 512880
```

#### 5.1.3 回测模式
```bash
python src/backtester.py --symbol 512660 --start-date 2025-01-01 --end-date 2025-11-24
```

#### 5.1.4 周线分析
```bash
python src/weekly_analyzer.py --symbol 512660
```

### 5.2 输出结果
- 扫描结果JSON文件（outputs/scan_results_*.json）
- 回测报告和图表
- 交易信号导出文件
- 日志记录

## 6. 系统扩展指南

### 6.1 添加新的交易标的
1. 在etfs.yaml中添加新的ETF配置
2. 确保设置正确的市场代码和类型
3. 根据ETF特性配置合适的风控参数

### 6.2 扩展信号检测算法
1. 修改calculator.py中的信号生成逻辑
2. 在divergence_detector.py中添加新的背驰检测方法
3. 更新signal_validator.py以支持新的信号类型

### 6.3 添加新的运行模式
1. 在main.py中添加新的模式处理函数
2. 配置相应的命令行参数
3. 实现数据流程和输出处理

## 7. 与之前版本的主要区别

### 7.1 架构改进
- 更清晰的模块分离
- 统一的数据处理流程
- 增强的配置管理

### 7.2 功能增强
- 支持更多类型的交易标的
- 改进的背驰检测算法
- 增强的信号验证机制
- 更完善的回测系统

### 7.3 性能优化
- 数据缓存机制
- 并行处理支持
- 资源使用优化

## 8. 维护与故障排除

### 8.1 日志系统
- 系统日志记录在logs/目录下
- 可通过loguru配置日志级别

### 8.2 常见问题排查
- 数据获取失败：检查网络连接和API配置
- 信号生成异常：检查数据完整性和计算参数
- 配置文件错误：使用config/check_config.py验证配置有效性

---

*本文档由系统自动生成，最后更新时间：2025年11月26日*